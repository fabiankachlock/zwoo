@inject IDatabase _db
@inject IUserService _userService
@inject DialogService DialogService

<RadzenCard>
    <div class="d-flex flex-row">
        <h3>@_player.Username</h3>
        @if (_player.Verified)
        {
            <RadzenIcon Icon="check_circle_outline" IconStyle="IconStyle.Success" Style="margin-left: 5px; margin-bottom: 5px"/>
        }
        else
        {
            <RadzenIcon Icon="highlight_off" IconStyle="IconStyle.Danger" Style="margin-left: 5px; margin-bottom: 5px"/>
        }
        
    </div>
    <p>@($"ID: {_player.Id}")</p>
    <p>@($"Email: {_player.Email}")</p>
    <p>@($"Games: {_gamesPlayed.Count()}")</p>
    <p>@($"Wins: {_player.Wins}")</p>
    @if (_player.BetaCode != null)
    {
        <p>@($"Betacode: {_player.BetaCode}")</p>
    }
</RadzenCard>

<RadzenTabs>
    <Tabs>
        <RadzenTabsItem Text="Account Events">
            <RadzenDataGrid AllowFiltering="true" AllowGrouping="true" AllowSorting="true" AllowPaging="true" PageSize="20" 
                            TItem="AccountEventDao" Data="_events" AllowVirtualization="true">
                <Columns>
                    <RadzenDataGridColumn TItem="AccountEventDao" Property="EventType" Title="Event"/>
                    <RadzenDataGridColumn TItem="AccountEventDao" Property="Success" Title="Success">
                        <Template Context="info">
                            @info.Success.ToString()
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="AccountEventDao" Property="TimeStamp" Title="Time">
                        <Template Context="aevent">
                            @DateTimeOffset.FromUnixTimeSeconds((long)aevent.TimeStamp).ToString("dd.MM.yy HH:mm:ss")
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenTabsItem>
        <RadzenTabsItem Text="Sessions">
            <RadzenDataGrid AllowFiltering="false" AllowGrouping="false" AllowSorting="false" AllowPaging="true" PageSize="20"
                            TItem="string" Data="_player?.Sid" AllowVirtualization="true" @ref="_playerSidGrid">
                <Columns>
                    <RadzenDataGridColumn TItem="string" Property="this" Title="Session ID"/>
                    <RadzenDataGridColumn TItem="string" Filterable="false" Sortable="false" Groupable="false" TextAlign="TextAlign.Center" Width="60px">
                        <Template Context="sid">
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Class="m-1" Click="@(args => DeleteRow(sid))"  @onclick:stopPropagation="true" />
                        </Template>
                        <EditTemplate Context="sid">
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Class="m-1" Click="@(args => DeleteRow(sid))" />
                        </EditTemplate>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenTabsItem>
        <RadzenTabsItem Text="Games Played">
            <RadzenDataGrid AllowFiltering="true" AllowGrouping="true" AllowSorting="true" AllowPaging="true" PageSize="25"
                            ExpandMode="DataGridExpandMode.Single" RowRender="@RenderRow"
                            TItem="GameInfoDao" Data="_gamesPlayed" AllowVirtualization="true">
                <Template Context="info">
                    <p>Scoreboard:</p>
                    <RadzenDataGrid TItem="PlayerScoreDao" Data="info.Scores">
                        <Columns>
                            <RadzenDataGridColumn TItem="PlayerScoreDao" Property="Score" Title="Score"/>
                            <RadzenDataGridColumn TItem="PlayerScoreDao" Property="PlayerUsername" Title="Name"/>
                        </Columns>
                    </RadzenDataGrid>
                </Template>
                <Columns>
                    <RadzenDataGridColumn TItem="GameInfoDao" Property="GameId" Title="ID"/>
                    <RadzenDataGridColumn TItem="GameInfoDao" Property="GameName" Title="Name"/>
                    <RadzenDataGridColumn TItem="GameInfoDao" Property="TimeStamp" Title="Time">
                        <Template Context="info">
                            @DateTimeOffset.FromUnixTimeSeconds((long)info.TimeStamp).ToString("dd.MM.yy HH:mm:ss")
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="GameInfoDao" Property="IsPublic" Title="Public">
                        <Template Context="info">
                            <RadzenCheckBox Disabled="true" Value="info.IsPublic"/>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="GameInfoDao" Property="Winner" Title="Winner" Sortable="false" Filterable="false"/>
                </Columns>
            </RadzenDataGrid>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    [Parameter] public ulong Id { set; get; }

    private UserDao? _player
    {
        get => _userService.GetUserById(Id);
    }

    private IEnumerable<AccountEventDao> _events
    {
        get => _db.AccountEvents.AsQueryable().Where(e => e.PlayerID == Id);
    }
    private IEnumerable<GameInfoDao> _gamesPlayed
    {
        get => _db.GamesInfo.AsQueryable().Where(x => x.Scores.Any(z => _player != null && _player.Username == z.PlayerUsername));
    }

    RadzenDataGrid<string> _playerSidGrid = new RadzenDataGrid<string>();
    
    @* protected override void OnInitialized()
    {
        _player = Globals.ZwooDatabase.GetUser(Id);
        _events = Globals.ZwooDatabase.GetUserAccountEvents(Id);
        _gamesPlayed = Globals.ZwooDatabase.GetPlayedGamesAsQueryable().Where(x => x.Scores.Any(x => x.PlayerUsername == _player.Username));
    } *@

    private async void DeleteRow(string sid)
    {
        // TODO: audit & co
        @* var res = await DialogService.Confirm($"Are you sure that you want to delete {_player.Username}s sid?", "Delete", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });
        if (res == null || (bool)!res)
            return;
        _player.Sid.Remove(sid);
        Globals.ZwooDatabase.UpdateUser(_player);
        await _playerSidGrid.Reload(); *@
    }
    
    private void RenderRow(RowRenderEventArgs<GameInfoDao> args) => args.Expandable = true;
}