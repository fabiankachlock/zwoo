@page "/games-overview"

<PageTitle>Games Overview</PageTitle>

@using ZwooInfoDashBoard.Data

<h1>Games Overview</h1>
<p>Tabel with all Played Games and the Scores of every Player.</p>

<RadzenDataGrid AllowFiltering="true" AllowGrouping="true" AllowSorting="true" AllowPaging="true" PageSize="25"
                ExpandMode="DataGridExpandMode.Single" RowRender="@RenderRow"
                TItem="GameInfo" Data="gameInfos" @ref="gamesDataGrid" AllowVirtualization="true">
    <Template Context="info">
        <p>Scoreboard:</p>
        <RadzenDataGrid TItem="PlayerScore" Data="info.Scores">
            <Columns>
                <RadzenDataGridColumn TItem="PlayerScore" Property="Score" Title="Score"/>
                <RadzenDataGridColumn TItem="PlayerScore" Property="Player" Title="Name">
                    <Template Context="score">
                        @score.Player.Username
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PlayerScore" Property="Player" Title="Email">
                    <Template Context="score">
                        @score.Player.Email
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="PlayerScore" Property="Player" Title="Wins">
                    <Template Context="score">
                        @score.Player.Wins
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </Template>
    <Columns>
        <RadzenDataGridColumn TItem="GameInfo" Property="GameID" Title="ID"/>
        <RadzenDataGridColumn TItem="GameInfo" Property="GameName" Title="Name"/>
        <RadzenDataGridColumn TItem="GameInfo" Property="TimeStamp" Title="Time">
            <Template Context="info">
                @DateTimeOffset.FromUnixTimeSeconds((long)info.TimeStamp).ToString("dd.MM.yy HH:mm:ss")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="GameInfo" Property="IsPublic" Title="Public">
            <Template Context="info">
                <RadzenCheckBox Disabled="true" Value="info.IsPublic"/>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="GameInfo" Property="Scores" Title="Winner">
            <Template Context="info">
                @GetUser((ulong)info.Scores.First(x => x.Score == 0).PlayerID).Username
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private IQueryable<GameInfo> gameInfos;
    private RadzenDataGrid<GameInfo> gamesDataGrid;

    private User GetUser(ulong id) => Globals.ZwooDatabase.GetUser(id);
    
    protected override async Task OnInitializedAsync() => gameInfos = Globals.ZwooDatabase.GetPlayedGamesAsQueryable();

    private void RenderRow(RowRenderEventArgs<GameInfo> args) => args.Expandable = true;
}